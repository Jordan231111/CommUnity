<!-- thread.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thread - CommUnity</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <header class="text-center py-6 bg-blue-600 text-white">
    <h1 class="text-4xl font-bold">Thread Details</h1>
    <nav class="mt-4">
      <a href="community.html" class="text-white hover:underline mx-2">Back to Community</a>
    </nav>
  </header>

  <main class="max-w-3xl mx-auto p-6 mt-10 bg-white rounded-lg shadow-lg">
    <h2 id="thread-title" class="text-2xl font-semibold mb-2"></h2>
    <p id="thread-location" class="text-gray-600 mb-4"></p>

    <!-- Comment Form -->
    <h3 class="text-xl font-semibold mb-2">Add a Comment</h3>
    <form id="commentForm" class="space-y-4">
      <textarea 
        id="commentInput" 
        placeholder="Enter your comment here..." 
        required 
        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
      ></textarea>
      <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Comment</button>
    </form>

    <!-- Comments List -->
    <h3 class="text-xl font-semibold mt-8 mb-4">Comments</h3>
    <div id="comments-container" class="space-y-4">
      <!-- Comments will be displayed here -->
    </div>
  </main>

  <!-- Scripts -->
  <script type="module">
    import { addCommentToThread, getCommentsWithUpvotes, incrementUpvote, decrementUpvote } from './database_funcs.js';

    const urlParams = new URLSearchParams(window.location.search);
    const threadId = urlParams.get('threadId');

    if (!threadId) {
      alert('Thread ID not provided');
      window.location.href = 'community.html';
    }

    async function displayThread() {
      try {
        const data = await getCommentsWithUpvotes(threadId);

        document.getElementById('thread-title').textContent = data.thread_name;
        document.getElementById('thread-location').textContent = `City: ${data.thread_city}, Zip Code: ${data.thread_zip}`;

        const commentsContainer = document.getElementById('comments-container');
        commentsContainer.innerHTML = '';

        data.comments.forEach(comment => {
          const commentDiv = document.createElement('div');
          commentDiv.className = 'bg-gray-100 p-4 rounded shadow';

          const textP = document.createElement('p');
          textP.textContent = comment.text;

          const upvotesP = document.createElement('p');
          upvotesP.textContent = `Upvotes: ${comment.upvotes}`;

          const upvoteButton = document.createElement('button');
          upvoteButton.className = 'text-green-600 hover:underline mr-2';
          upvoteButton.textContent = 'Upvote';
          upvoteButton.onclick = async () => {
            await incrementUpvote(threadId, comment.id);
            await displayThread();
          };

          const downvoteButton = document.createElement('button');
          downvoteButton.className = 'text-red-600 hover:underline';
          downvoteButton.textContent = 'Downvote';
          downvoteButton.onclick = async () => {
            await decrementUpvote(threadId, comment.id);
            await displayThread();
          };

          commentDiv.appendChild(textP);
          commentDiv.appendChild(upvotesP);
          commentDiv.appendChild(upvoteButton);
          commentDiv.appendChild(downvoteButton);

          commentsContainer.appendChild(commentDiv);
        });
      } catch (error) {
        console.error('Error displaying thread:', error);
      }
    }

    document.getElementById('commentForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const commentText = document.getElementById('commentInput').value.trim();

      if (!commentText) {
        alert('Please enter a comment.');
        return;
      }

      try {
        await addCommentToThread(threadId, commentText);
        document.getElementById('commentForm').reset();
        await displayThread();
      } catch (error) {
        console.error('Error adding comment:', error);
      }
    });

    displayThread();
  </script>
</body>
</html>
